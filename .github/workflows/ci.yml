name: CI / CD ‚Äì Polyglot Starter

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:

jobs:
  setup-build-test:
    name: üß™ Install, Build & Test
    runs-on: ubuntu-latest

    permissions:
      contents: read

    steps:
      # ------------------------------
      # 1. Checkout the repository
      # ------------------------------
      - name: üõéÔ∏è Checkout repository
        uses: actions/checkout@v4

      # ------------------------------
      # 2. Setup Node.js (v18+)
      # ------------------------------
      - name: üß∞ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 18.x

      # ------------------------------
      # 3. Enable Corepack & install pnpm
      # ------------------------------
      - name: ‚öôÔ∏è Enable Corepack & Prepare pnpm
        run: |
          corepack enable
          corepack prepare pnpm@latest --activate
          pnpm -v

      # ------------------------------
      # 4. Cache pnpm store for faster installs
      # ------------------------------
      - name: üß± Setup pnpm Cache
        uses: actions/cache@v4
        with:
          path: ~/.pnpm-store
          key: ${{ runner.os }}-pnpm-v2-${{ hashFiles('**/pnpm-lock.yaml') }}
          restore-keys: |
            ${{ runner.os }}-pnpm-v2-

      # ------------------------------
      # 5. Install dependencies via setup.sh
      # ------------------------------
      - name: üì¶ Install Dependencies
        run: |
          chmod +x setup.sh
          ./setup.sh --skip-dev-servers
        env:
          CI: true

      # ------------------------------
      # 6. Verify build artifacts
      # ------------------------------
      - name: ‚úÖ Verify Build Artifacts
        run: |
          echo "Verifying workspace builds..."
          for ws in api proxy web; do
            if [ -d "$ws" ]; then
              echo "‚Üí Checking $ws build output..."
              ls -la "$ws" || true
            fi
          done

      # ------------------------------
      # 7. Lint & test (if scripts exist)
      # ------------------------------
      - name: üßπ Run Lint & Tests (optional)
        run: |
          pnpm -r run lint --if-present
          pnpm -r run test --if-present

  # ========================================================================
  # Deploy Web (Vercel)
  # ========================================================================
  deploy-web:
    name: üöÄ Deploy Web (Vercel)
    needs: [setup-build-test]
    runs-on: ubuntu-latest
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 18.x

      - name: ‚öôÔ∏è Enable Corepack & Prepare pnpm
        run: |
          corepack enable
          corepack prepare pnpm@latest --activate

      - name: Check Vercel Secrets
        id: secrets
        run: |
          if [ -z "${{ secrets.VERCEL_TOKEN }}" ] || [ -z "${{ secrets.VERCEL_ORG_ID }}" ] || [ -z "${{ secrets.VERCEL_PROJECT_ID }}" ]; then
            echo "missing=true" >> $GITHUB_OUTPUT
          else
            echo "missing=false" >> $GITHUB_OUTPUT
          fi

      - name: Deploy to Vercel
        env:
          VERCEL_TOKEN: ${{ secrets.VERCEL_TOKEN }}
          VERCEL_ORG_ID: ${{ secrets.VERCEL_ORG_ID }}
          VERCEL_PROJECT_ID: ${{ secrets.VERCEL_PROJECT_ID }}
        if: steps.secrets.outputs.missing == 'false'
        run: |
          npm i -g vercel@latest
          cd web
          vercel pull --yes --environment=production --token="$VERCEL_TOKEN"
          vercel --prod --token="$VERCEL_TOKEN"

      - name: Skip Vercel Deploy (Secrets Missing)
        if: steps.secrets.outputs.missing == 'true'
        run: |
          echo "Skipping Vercel deployment because required secrets are missing."

  # ========================================================================
  # Deploy API (Render)
  # ========================================================================
  deploy-api:
    name: ‚ö° Deploy API (Render)
    needs: [setup-build-test]
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main'

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 18.x

      - name: ‚öôÔ∏è Enable Corepack & Prepare pnpm
        run: |
          corepack enable
          corepack prepare pnpm@latest --activate

      - name: üì¶ Verify API Workspace
        run: |
          echo "üïí Workflow run at: $(date)"
          echo "üîß Using FIXED workflow (no pnpm install --frozen-lockfile)"
          if [ -d "api" ]; then
            echo "‚úÖ API workspace found"
            echo "üìã API package.json:"
            cat api/package.json | head -10
          else
            echo "‚ùå No API workspace found"
          fi

  # ========================================================================
  # Optional: Docker image builds (GHCR)
  # ========================================================================
  docker-build:
    name: üê≥ Build & Push Docker Images
    needs: [setup-build-test]
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main'
    
    permissions:
      contents: read
      packages: write
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to GHCR
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Build & Push Images
        run: |
          OWNER=$(echo "${{ github.repository_owner }}" | tr '[:upper:]' '[:lower:]')
          for ws in api web proxy; do
            if [ -f "$ws/Dockerfile" ]; then
              IMAGE=ghcr.io/$OWNER/$ws:latest
              echo "üöÄ Building and pushing $IMAGE"
              docker build -t $IMAGE $ws
              docker push $IMAGE
            else
              echo "‚ö†Ô∏è No Dockerfile for $ws ‚Äì skipping."
            fi
          done
